<!DOCTYPE html>
<head>
    <meta charset="UTF-8">
    <title>Painel</title>
    <link rel='stylesheet' href="panel.css">
</head>
<body class="row" onload="populate_table()"><!--/body> onload="populate_table()">-->
    <script src="testeregex.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.18.0/axios.min.js"></script>
    
    <script >
        async function insertRegister(id, license, entrance_type) {
            var res;
            await axios.put('http://localhost:3000/register',  { params: {id: id, license: license, entrance_type: entrance_type} })
                .then(response => { res = response.data;} )
                .catch(error => console.log(error));
            return res;
        }

        async function updateRegister(license) {
            var res;
            await axios.patch('http://localhost:3000/register',  { params: {exit_time: exit_time, license: license, entrance_time: entrance_time} })
                .then(response => { res = response.data;} )
                .catch(error => console.log(error));
            return res;
        }

        async function getActiveRegisters() {
            var date_now = new Date();
            var res;
            await axios.get('http://localhost:3000/registers', { params: {timestamp: date_now} })
                .then(response => { res = response.data;} )
                .catch(error => console.log(error));
            return res;
        }

        function get_total_a_pagar (tempo, vip) {
            var taxa_vip = 4;
            var taxa_tempo = 3;
            var intervalo = 20;
            try {
                var date_now = new Date();
                var tempo_total = date_now.getHours() + (date_now.getMinutes()/intervalo) - tempo.getHours() + (tempo.getMinutes()/intervalo);
                
                var preco_total;

                if (vip != 0)
                    preco_total = taxa_tempo*tempo_total + taxa_vip;
                else
                    preco_total = taxa_tempo*tempo_total;

                return preco_total;
            }
            catch {
                console.log(console.error());
            }
        }

        function  generate_new_random_license()
        {
            //alert("Gerando nova placa ...");
            //console.log("Gerando nova placa...");

            return generate_license();
        }

        function random_obstructed_license () {
            return Math.floor(Math.random() * 5);
        }

        var ja_chamou = false;

        function populate_table()
        {
            if (!ja_chamou)
            {     
                var table = document.getElementById("my_table");
                var numberRows = table.rows.length; //-1 porque a primeira linha da tabela são os nomes das colunas

                for (i = 0; i < 5; i++) {

                    var row = table.insertRow(numberRows + 1);

                    var new_row = ["000" + (numberRows + 1), generate_license(), "Carro", (new Date()).toString().split(' GMT')[0], "NULL", "Não"];
                    var count = 0;

                    new_row.forEach(element => {
                        var cell = row.insertCell(count);
                        cell.innerHTML = element;
                        count++;
                    });
                    
                }
            }

        }

        function validate_request (generate_random_license) {
            var entrance_license;
            
            if (generate_random_license[0].checked) { if (generate_random_license[0].value=="Sim" ) entrance_license = null; else return;}
            else if (generate_random_license[1].checked) { 
                if (generate_random_license[1].value != "Não") return ;
                
                if (document.getElementById("entrance_license").value == "") { alert("Por favor, digite um valor válido para a placa do veículo ou selecione a opção 'Sim'."); return; }
                else { entrance_license = document.getElementById("entrance_license").value;  }
            }
            else { alert("Por favor, digite um valor válido para a placa do veículo ou selecione a opção 'Sim'."); return null; }
            
            var sem_parar = 0;
            var inputs_sem_parar = document.getElementsByName("sem-parar-input");
            if (inputs_sem_parar[0].checked ) { sem_parar = inputs_sem_parar[0].value; }
            else if (inputs_sem_parar[1].checked ) { sem_parar = inputs_sem_parar[1].value; }
            else { alert ("Selecione uma opção de sem-parar"); return  null}

            var tipo = 0;
            var inputs_type = document.getElementsByName("type-input");
            if (inputs_type[0].checked ) { tipo = inputs_type[0].value; }
            else if (inputs_type[1].checked ) { tipo = inputs_type[1].value; }
            else { alert ("Selecione um tipo de veículo"); return  null}

            return {"entrance_license": entrance_license, "sem_parar": sem_parar, "tipo": tipo};
        }

        function entrance(){
            
            var generate_random_license = document.getElementsByName("random-license-input");
            var response = validate_request(generate_random_license);

            if (response == null)
                return;
                
            var entrance_license;
            if (!response.entrance_license)
                entrance_license = generate_license();
            var sem_parar = response.sem_parar;
            var tipo = response.tipo;

            if (random_obstructed_license() == 1) {
                alert("Ooops:( Placa obstruída! Tente entrar novamente ou acione ajuda.");
            } else {
                var table = document.getElementById("my_table_tbody");
                var numberRows = table.rows.length;

                var row = table.insertRow(numberRows);
                var date_now = new Date();
                var date_later = new Date();
                date_later.setHours(date_now.getHours() + 2);
                var new_row = ["000" + (numberRows + 1), entrance_license, tipo, date_now.toString().split(' GMT')[0], "NULL", "R$ " + get_total_a_pagar(date_later, sem_parar) , sem_parar];
                var count = 0;

                new_row.forEach(element => {
                    var cell = row.insertCell(count);
                    cell.innerHTML = element;
                    count++;
                });
            }
                
        }

        function exit(){
            var exit_license = document.getElementById("exit_license").value;
            if (exit_license == "")
                alert("Por favor, digite um valor válido para a placa do veículo.")
            else{
                alert("Veículo com placa '" + exit_license + "' saindo...")
                var table = document.getElementById("my_table_tbody");
                var numberRows = table.rows.length - 1;
                var count = 1;
                var deleted = 0;

                for (var i = 0; i < table.rows.length; i++) {
                    if ( table.rows.item(i).cells.item(1).innerHTML == exit_license) {
                        document.getElementById("my_table_tbody").deleteRow(i);
                        deleted = 1;
                    }
                }

                if (deleted == 0) {
                    alert("Nenhum registro foi encontrado com a placa fornecida")
                }

            }
        }

        function erase_data(){
            alert("Apagando os dados...")
        }

    </script>


    <aside class="control column shadow">

        <div >
            <h2 class="placa_veiculo_title">Placa do veículo</h2>
            <input id="entrance_license" class="round_font"/>
        </div>

        <div class="border">
            <h3>Gerada automaticamente?</h3> 
            
            <input class="checkboxes " type="radio" name="random-license-input" value="Sim">Sim
            <input class="checkboxes " type="radio" name="random-license-input" value="Não">Não
        </div>
            
        

        <div>
            <h3>Possui sem parar?</h3>
            <input class="checkboxes" type="radio" name="sem-parar-input" value="Sim">Sim
            <input class="checkboxes" type="radio" name="sem-parar-input" value="Não">Não
        </div>

        <div>
            <input class="checkboxes" type="radio" name="type-input" value="Carro">Carro
            <input class="checkboxes" type="radio" name="type-input" value="Moto">Moto
        </div>


        <div class="panel">
            <button class="round_font" id="btn_entrance" onclick="entrance()">Entrada de veículo</button>
            <h4>Tela do Leo</h4>
        </div>

        <div>
            <h2>Placa do veículo</h2>
            <input id="exit_license"/>

        </div>

        <div class="panel">
            
            <button class="round_font" id="btn_exit" onclick="exit()">Saída de veículo</button>

            <h4>Tela do Leo</h1>

            <button id="btn_erase_data" onclick="erase_data()">Apagar todos os dados</button>
        </div>

    </aside>


    <table id="my_table" class="column">
        <thead>
            <th>#</th>
            <th>Placa</th>
            <th>Tipo</th>
            <th>Entrada</th>
            <th>Pagamento</th>
            <th>Total a pagar</th>
            <th>Sem parar</th>
        </thead>
        <tbody id="my_table_tbody">

        </tbody>
    </table>
</body>
</html>