<!DOCTYPE html>
<head>
    <meta charset="UTF-8">
    <title>Painel</title>
    <link rel='stylesheet' href="panel.css">
</head>
<body class="row" onload="populate_table()">
    <script src="testeregex.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.18.0/axios.min.js"></script>
    
    <script >
        async function insertRegister(id, license, entrance_type) {
            var res;
            await axios.post('http://localhost:3000/register',  { params: {id: id, license: license, entrance_type: entrance_type} })
                .then(response => { res = response.data;} )
                .catch(error => console.log(error));
            return res;
        }

        async function updateRegister(license, exit_time, entrance_time) {
            var res;
            await axios.patch('http://localhost:3000/register',  { params: {exit_time: exit_time, license: license, entrance_time: entrance_time} })
                .then(response => { res = response.data;} )
                .catch(error => console.log(error));
            return res;
        }

        async function getActiveRegisters() {
            var date_now = new Date();
            var formatted_date = date_now.getDay() + '/' + date_now.getMonth() + '/' + date_now.getFullYear().toString()[2] + date_now.getFullYear().toString()[3] + ' ' + date_now.getHours() + ':' + date_now.getMinutes() + ':' + date_now.getSeconds() + ',' + date_now.getMilliseconds();
            console.log(formatted_date) 
            var res;
            await axios.get('http://localhost:3000/registers', { params: {active: true} })
                .then(response => { res = response.data;} )
                .catch(error => console.log(error));
            return res;
        }

        async function getTotalAPagar(entrance_id) {
            var res;
            await axios.get('http://localhost:3000/payment', { params: {entrance_id: entrance_id} })
                .then(response => { res = response.data;} )
                .catch(error => console.log(error));
            return res;
        }

        function get_total_a_pagar (tempo, vip) {
            var taxa_vip = 4;
            var taxa_tempo = 3;
            var intervalo = 20;
            try {
                var date_now = new Date();
                var tempo_total = date_now.getHours() + (date_now.getMinutes()/intervalo) - tempo.getHours() + (tempo.getMinutes()/intervalo);
                
                var preco_total;

                if (vip != 0)
                    preco_total = taxa_tempo*tempo_total + taxa_vip;
                else
                    preco_total = taxa_tempo*tempo_total;

               //Formatar preço com padrões pr-br      
                var preco_total_formatado = preco_total.toLocaleString('pt-br',{style: 'currency', currency: 'BRL'});    
                return preco_total_formatado;
            }
            catch {
                console.log(console.error());
            }
        }

        function  generate_new_random_license()
        {
            //alert("Gerando nova placa ...");
            //console.log("Gerando nova placa...");

            return generate_license();
        }

        function uuid() {
            //solucao https://pt.stackoverflow.com/questions/198003/como-gerar-uuids-guids-com-javascript
        // Retorna um número randômico entre 0 e 15.
        function randomDigit() {

            // Se o browser tiver suporte às bibliotecas de criptografia, utilize-as;
            if (crypto && crypto.getRandomValues) {
            
                // Cria um array contendo 1 byte:
                var rands = new Uint8Array(1);
                
                // Popula o array com valores randômicos
                crypto.getRandomValues(rands);
                
                // Retorna o módulo 16 do único valor presente (%16) em formato hexadecimal
                return (rands[0] % 16).toString(16);
            } else {
            // Caso não, utilize random(), que pode ocasionar em colisões (mesmos valores
            // gerados mais frequentemente):
                return ((Math.random() * 16) | 0).toString(16);
            }
        }

        // A função pode utilizar a biblioteca de criptografia padrão, ou
        // msCrypto se utilizando um browser da Microsoft anterior à integração.
        var crypto = window.crypto || window.msCrypto;

        // para cada caracter [x] na string abaixo um valor hexadecimal é gerado via
        // replace:
        return 'xxxxxxxx-xxxx-4xxx-8xxx-xxxxxxxxxxxx'.replace(/x/g, randomDigit);
        }

        function random_obstructed_license () {
            return Math.floor(Math.random() * 5);
        }

        async function populate_table()
        {            
            var result;
            result = await  getActiveRegisters();
            console.log(result);
            
            if (result != "Response is undefined") {
                result.forEach( (i) => {
                    //alert(i[1]);
                    var table = document.getElementById("my_table");
                    var numberRows = table.rows.length;

                    var row = table.insertRow(numberRows);
                    payment_value = 0.00
                    var date = new Date(i[2]);
                    console.log(date.getDate());
                    var new_row = [i[0], i[1], "Carro", date.toString().split(' GMT')[0], i[3], "R$" + 0.00 , i[4]]
                    var count = 0;
                    new_row.forEach(element => {
                            var cell = row.insertCell(count);
                            cell.innerHTML = element;
                            count++;
                        });
                    
                });
            } else alert("Erro ao buscar dados no banco de dados");  
        }

        async function showPaymentValue () {
            
            try {
                    var table = document.getElementById("my_table");
                    var numberRows = table.rows.length;
                    
                    for (var i = 1; i < numberRows; i++) {
                        var value_to_pay =  await getTotalAPagar(table.rows[i].cells[0].innerHTML);
                        table.rows[i].cells[5].innerHTML = "R$ " + (value_to_pay[0][3]).toString().substring(0,5);
                    }

                } catch (err) { console.log(err) }
        }

        function validate_request (generate_random_license) {
            var entrance_license;
            
            if (generate_random_license[0].checked) { if (generate_random_license[0].value=="Sim" ) entrance_license = null; else return;}
            else if (generate_random_license[1].checked) { 
                if (generate_random_license[1].value != "Não") return ;
                
                if (document.getElementById("entrance_license").value == "") { alert("Por favor, digite um valor válido para a placa do veículo ou selecione a opção 'Sim'."); return; }
                else { entrance_license = document.getElementById("entrance_license").value;  }
            }
            else { alert("Por favor, digite um valor válido para a placa do veículo ou selecione a opção 'Sim'."); return null; }
            
            var sem_parar = 0;
            var inputs_sem_parar = document.getElementsByName("sem-parar-input");
            if (inputs_sem_parar[0].checked ) { sem_parar = inputs_sem_parar[0].value; }
            else if (inputs_sem_parar[1].checked ) { sem_parar = inputs_sem_parar[1].value; }
            else { alert ("Selecione uma opção de sem-parar"); return  null}

            var tipo = 0;
            var inputs_type = document.getElementsByName("type-input");
            if (inputs_type[0].checked ) { tipo = inputs_type[0].value; }
            else if (inputs_type[1].checked ) { tipo = inputs_type[1].value; }
            else { alert ("Selecione um tipo de veículo"); return  null}

            return {"entrance_license": entrance_license, "sem_parar": sem_parar, "tipo": tipo};
        }

        function generateId (numberRows) {
            return uuid();
        }

        async function entrance(){
            
            //console.log(uuid());
            
            var generate_random_license = document.getElementsByName("random-license-input");
            var response = validate_request(generate_random_license);

            if (response == null)
                return;
                
            var entrance_license;
            if (!response.entrance_license)
                entrance_license = generate_license();
            else entrance_license = document.getElementById("entrance_license").value.toUpperCase();
            var sem_parar = response.sem_parar;
            var tipo = response.tipo;

            if (random_obstructed_license() == 1) {
                alert("Ooops:( Placa obstruída! Tente entrar novamente ou acione ajuda.");
            } else {
                var table = document.getElementById("my_table");
                var numberRows = table.rows.length;

                var row = table.insertRow(numberRows);
                var date_now = new Date();
                var date_later = new Date();
                date_later.setHours(date_now.getHours() + 2);
                var id = generateId(numberRows);

                var new_row = [id, entrance_license, tipo, date_now.toString().split(' GMT')[0], "NULL", " " + get_total_a_pagar(date_later, sem_parar) , sem_parar];

                var count = 0;

                new_row.forEach(element => {
                    var cell = row.insertCell(count);
                    cell.innerHTML = element;
                    count++;
                });

                await insertRegister(id, entrance_license, tipo);
            }
                
        }

        async function exit(){
            var exit_license = document.getElementById("exit_license").value;
            if (exit_license == "")
                alert("Por favor, digite um valor válido para a placa do veículo.")
            else{
                alert("Veículo com placa '" + exit_license + "' saindo...")
                var table = document.getElementById("my_table");
                var numberRows = table.rows.length - 1;
                var count = 1;
                var deleted = 0;
                var entrance_time;

                for (var i = 0; i < table.rows.length; i++) {
                    if ( table.rows.item(i).cells.item(1).innerHTML == exit_license) {
                        entrance_time = table.rows.item(i).cells.item(3);
                        document.getElementById("my_table").deleteRow(i);
                        deleted = 1;
                    }
                }

                if (deleted == 0) {
                    alert("Nenhum registro foi encontrado com a placa fornecida")
                } else {
                    
                    await updateRegister(exit_license, new Date(), entrance_time);
                }

            }
        }

        function erase_data(){
            alert("Apagando os dados...")
        }

        function changeEntranceInput() {
            var checkBox = document.getElementById("yes_check");
            var textBox = document.getElementById("entrance_license");

            if(checkBox.checked == true) {
                textBox.disabled = true;
            }
            else {
                textBox.disabled = false;
            }
        }
        
    </script>


    <aside class="control column shadow">

        <div >
            <h2 class="placa_veiculo_title">Placa do veículo</h2>
            <input id="entrance_license" class="round_font" disabled/>
        </div>

        <div class="border">
            <h3>Gerada automaticamente?</h3> 
            
            <input id="yes_check" class="checkboxes " type="radio" name="random-license-input" value="Sim" onclick="changeEntranceInput()" checked>Sim
            <input id="no_check" class="checkboxes " type="radio" name="random-license-input" value="Não" onclick="changeEntranceInput()">Não
        </div>
            
        

        <div>
            <h3>Possui sem parar?</h3>
            <input class="checkboxes" type="radio" name="sem-parar-input" value="Sim">Sim
            <input class="checkboxes" type="radio" name="sem-parar-input" value="Não" checked>Não
        </div>

        <div>
            <input class="checkboxes" type="radio" name="type-input" value="Carro" checked>Carro
            <input class="checkboxes" type="radio" name="type-input" value="Moto">Moto
        </div>


        <div class="panel">
            <button class="round_font" id="btn_entrance" onclick="entrance()">Entrada de veículo</button>
            <h4>Precisa de ajuda?<br>
                <button id="btn_help" onclick="alert('Ajuda chamada!')">Chamar ajuda</button>
            </h4>
        </div>

        <div>
            <h2 class="placa_veiculo_title">Placa do veículo</h2>
            <input id="exit_license" class="round_font"/>

        </div>

        <div class="panel">
            
            <button class="round_font" id="btn_exit" onclick="exit()">Saída de veículo</button>

            <h4>Precisa de ajuda?<br>
                <button id="btn_help" onclick="alert('Ajuda chamada!')">Chamar ajuda</button>
            </h4>
        </div>

        <div> <!-- Mover para algum lugar entre a Entrada e a Saida  -->
            <button class="btn_payment" onclick="window.location.href='./pagamento/inserir_placa.html'">Pagamento</button>
        </div>

        <div>
            <button id="btn_erase_data" onclick="erase_data()">Apagar todos os dados</button>
        </div>

    </aside>


    <table id="my_table" class="column">
        <tr>
            <th>#</th>
            <th>Placa</th>
            <th>Tipo</th>
            <th>Entrada</th>
            <th>Pagamento</th>
            <th>Total a pagar</th>
            <th>Tipo</th>
        </tr>
        <!--<tbody id="my_table_tbody">
            <tr></tr>

        </tbody>-->
    </table>

    <button id="btnCalcularSalario" onclick="showPaymentValue()">Calcular salario</button>
</body>
</html>